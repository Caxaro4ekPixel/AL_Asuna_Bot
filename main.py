import time
import telebot
from telebot import types
import sqlite3
import requests
import threading
from telegram import ParseMode
from datetime import datetime, timedelta
import os
from utils import name_month, name_week_day, log, convert_to_preferred_format
from check_time import checkTime
from reader_RSS import check
from decouple import config

bot = telebot.TeleBot(config("TOKEN"), parse_mode=None)
con = sqlite3.connect('db.db', check_same_thread=False)


@bot.message_handler(commands=['start'])
def start(message):
    log(f"send start {message.chat.id, message.chat.username, message.text}")
    bot.send_message(chat_id=734264203,
                     text=("@" + message.chat.username + " - " + message.text + " - " + message.chat.type))
    # if message.chat.id == 734264203:
    #     a = bot.send_message(734264203, "asdasdadsasdads")
    #     bot.pin_chat_message(chat_id=message.chat.id, message_id=a.message_id)
    if message.chat.type == 'group' or message.chat.type == 'supergroup':
        relese_id = message.text.replace("/start ", "")
        response = requests.get(f'https://api.anilibria.tv/v2/getTitle?id={relese_id}').json()
        if "error" in response:
            bot.send_message(message.chat.id, 'üßê–¢–∞–∫–æ–≥–æ —Ä–µ–ª–∏–∑–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!üßê')
        else:
            bottons = [[types.InlineKeyboardButton(text="–î–∞", callback_data='1')],
                       [types.InlineKeyboardButton(text="–ù–µ—Ç", callback_data='0')]]
            bot.send_message(message.chat.id, f'–†–µ–ª–∏–∑: {response["names"]["ru"]}?\nID: {relese_id}',
                             reply_markup=types.InlineKeyboardMarkup(bottons))
    else:
        pass


@bot.message_handler(commands=['update'])
def update(message):
    log(f"select update {message.chat.id, message.chat.username, message.text}")
    bot.send_message(chat_id=734264203,
                     text=("@" + message.chat.username + " - " + message.text + " - " + message.chat.type))
    if message.chat.type == 'group' or message.chat.type == 'supergroup':
        cur = con.cursor()
        relese_id = message.text.replace("/update ", "")
        cur.execute(f'''select * from chats where id={message.chat.id}''')
        chat = cur.fetchone()

        response = requests.get(f'https://api.anilibria.tv/v2/getTitle?id={relese_id}').json()
        if "error" in response:
            bot.send_message(message.chat.id, 'üßê–¢–∞–∫–æ–≥–æ —Ä–µ–ª–∏–∑–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!üßê')
        elif chat:
            cur.execute(f'''update chats set id_relese={relese_id} where id={message.chat.id}''')
            bot.send_message(chat_id=message.chat.id, text="‚úÖ–ü–µ—Ä–µ–∑–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à–ª–∞!‚úÖ")

        con.commit()
        cur.close()
    else:
        bot.send_message(message.chat.id, '–ù–µ –¢—Ä–æ–ñ –±–æ—Ç–∞ –≤ –ª—Å)')


@bot.message_handler(commands=['stop'])
def stop(message):
    log(f'send stop {message.chat.id, message.chat.username, message.text}')
    bot.send_message(734264203, "–ê–õ–Ø–Ø–Ø–†–ú!")
    if message.chat.id in [253296124, 734264203, 1625017611, 470092294]:
        bot.send_message(message.chat.id, "Bot is deactivated")
        bot.stop_bot()


@bot.message_handler(commands=['raw'])
def set_raw(message):
    log(f'set raw {message}', 'info')
    bot.send_message(chat_id=734264203,
                     text=("@" + message.chat.username + " - " + message.text + " - " + message.chat.type))
    if message.chat.type == 'group' or message.chat.type == 'supergroup':
        try:
            raw = message.text.replace("/raw ", "")
            if '/raw' in raw:
                bot.send_message(message.chat.id, "‚ùå–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–æ –≤–≤–µ–¥–µ–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ‚ùå")
            else:
                cur = con.cursor()
                cur.execute(f'''update chats set raw='{raw}' where id = {message.chat.id};''')
                con.commit()
                cur.close()
                bot.send_message(message.chat.id, f'‚úÖ–£—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ "{raw}"‚úÖ')
        except:
            log(f'error set raw {message}', 'error')
    else:
        bot.send_message(message.chat.id, '–ù–µ –¢—Ä–æ–ñ –±–æ—Ç–∞ –≤ –ª—Å)')


@bot.message_handler(commands=['report'])
def result(message):
    log(f'get report {message.chat.id}, {message.chat.username}, {message.chat.type}', 'info')
    bot.send_message(chat_id=734264203,
                     text=("@" + message.chat.username + " - " + message.text + " - " + message.chat.type))
    bot.send_message(message.chat.id, "üìà–û–∂–∏–¥–∞–π—Ç–µ! —Ñ–æ—Ä–º–∏—Ä—É—é –æ—Ç—á—ë—Çüìà")
    cur = con.cursor()
    try:
        response = requests.get(f"https://api.anilibria.tv/v2/getSchedule").json()
        mess_dict = {0: [], 1: [], 2: [], 3: [], 4: [], 5: [], 6: []}
        for week in response:
            for relese in week['list']:
                cur.execute(f'''select * from results where id={relese["id"]}''')
                res = cur.fetchone()
                a = datetime.fromtimestamp(relese['updated'])
                time_up = f"{a.day} {name_month(a.month)} {a.hour if a.hour > 9 else f'0{a.hour}'}:{a.minute if a.minute > 9 else f'0{a.minute}'}:{a.second if a.second > 9 else f'0{a.second}'}"

                em = "üîò"
                if res:
                    if res[3] == -1:
                        time_up = f"–í —Ä–∞–±–æ—Ç–µ! (–ø—Ä–µ–¥—ã–¥—É—â–∞—è —Å–µ—Ä–∏—è –≤—ã—à–ª–∞ {time_up})"
                        em = "üé§"
                    else:
                        timer = timedelta(seconds=int(res[3]))
                        days = timer.days
                        _time = convert_to_preferred_format(timer.seconds)
                        daysstr = ('–¥–µ–Ω—å' if 2 > days > 0 else ('–¥–Ω—è' if 1 < days < 5 else '–¥–Ω–µ–π'))
                        if days == 0:
                            em = "üü¢"
                        elif days == 1 and timer.seconds >= 7200:
                            em = "üü°"
                        elif days >= 4 and timer.seconds >= 7200:
                            em = "üî¥"

                        time_up = f"{days} {daysstr} –∏ {_time} (—Å–µ—Ä–∏—è –≤—ã—à–ª–∞ {time_up})"

                voice = ', '.join(w for w in relese['team']['voice'])
                timing = (' / ' + ', '.join(w for w in relese['team']['timing']) if relese['team']['timing'] else "")
                editing = (' / ' + ', '.join(w for w in relese['team']['editing']) if relese['team']['editing'] else "")
                decor = (' / ' + ', '.join(w for w in relese['team']['decor']) if relese['team']['decor'] else "")
                translator = (' / ' + ', '.join(w for w in relese['team']['translator']) if relese['team']['translator'] else "")
                last_ser = relese['player']['series']['last']
                all_ser = (relese['type']['series'] if relese['type']['series'] is not None else '?')

                mess_dict[relese['season']['week_day']].append(
                    f"""{em}<a href='https://www.anilibria.tv/release/{relese['code']}.html'>{relese['names']['ru']}</a> - ({voice}{timing}{translator}{editing}{decor})\n({last_ser}/{all_ser}) - <b>{time_up}</b>{' <u>–†–ï–õ–ò–ó –ó–ê–í–ï–†–®–Å–ù!</u>' if last_ser == all_ser else ''}\n""")

        for i in mess_dict:
            mes = ''
            mes += f'<u>{name_week_day(i)}</u>\n\n'
            for s in mess_dict[i]:
                mes += s
            mes += '\n-----------------\n'
            bot.send_message(chat_id=message.chat.id, text=mes, parse_mode=ParseMode.HTML,
                             disable_web_page_preview=True)
    except Exception as err:
        log(f"ERROR {Exception} and {err}", "error")
        bot.send_message(message.chat.id, "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –æ—Ç—á—ë—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω")
    finally:
        cur.close()


@bot.callback_query_handler(func=lambda call: True)
def query_handler(call):
    bot.answer_callback_query(callback_query_id=call.id)
    cur = con.cursor()
    if call.data == '1':
        cur.execute(f'''select * from chats where id={call.message.chat.id}''')
        chat = cur.fetchone()
        if chat:
            bot.send_message(chat_id=call.message.chat.id,
                             text='–ó–∞–ø–∏—Å—å –∏–∑ —ç—Ç–æ–≥–æ —á–∞—Ç–∞ —É–∂–µ –µ—Å—Ç—å, –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –∫–æ–º–∞–Ω–¥–æ–π /update id')
        else:
            relese_id = call.message.text.split('\n')[1].replace('ID: ', '')
            response = requests.get(f'https://api.anilibria.tv/v2/getTitle?id={relese_id}').json()
            cur.execute(
                f'''insert into chats (id, name, id_relese, code, name_ru, name_en, raw) values ({call.message.chat.id}, "{call.message.chat.title}", {int(relese_id)}, "{response['code']}", "{response['names']['ru']}", "{response['names']['en']}", "SubsPlease");''')
            bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.id, text='‚úÖ–£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ!‚úÖ')

        con.commit()

    elif call.data == '0':
        bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.id,
                              text='–¢–æ–≥–¥–∞ –ø–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä—å id –∏ –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞ /start id')


thread1 = threading.Thread(target=check, args=[bot, con])
thread1.start()
thread3 = threading.Thread(target=checkTime, args=[bot, con])
thread3.start()

if __name__ == '__main__':
    while True:
        try:
            bot.polling(none_stop=True)
        except Exception as err:
            if err.args[0] == 'cannot join current thread':
                log(f"ERROR {Exception} and {err}", "error")
                os.abort()
            else:
                time.sleep(200)
